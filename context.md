# Contexto de arquitectura y colaboración de componentes

Este documento resume las clases más relevantes del repositorio, destacando sus métodos públicos y cómo interactúan entre las capas ubicadas en los distintos proyectos (`Backend/ProyectoBase.Domain`, `Backend/ProyectoBase.Application`, `Backend/ProyectoBase.Infrastructure` y `Backend/ProyectoBase.Api`).

## Backend/ProyectoBase.Domain

| Clase | Responsabilidad | Métodos públicos | Dependencias y flujo |
| --- | --- | --- | --- |
| [`Entities.Product`](Backend/ProyectoBase.Domain/Entities/Product.cs) | Entidad de dominio que encapsula las reglas de negocio de un producto. | Constructor, `UpdateName`, `UpdateDescription`, `ChangePrice`, `IncreaseStock`, `DecreaseStock`. | Usa las excepciones de dominio para validar invariantes y es mapeada desde/hacia DTO en `ProyectoBase.Application`.【F:Backend/ProyectoBase.Domain/Entities/Product.cs†L7-L112】 |
| [`Services.ProductStockService`](Backend/ProyectoBase.Domain/Services/ProductStockService.cs) | Servicio de dominio que verifica disponibilidad de inventario. | `IsStockAvailableAsync`. | Depende de `Repositories.IProductReadRepository`; se invoca desde la capa de aplicación para validar cantidades antes de confirmar operaciones. |【F:Backend/ProyectoBase.Domain/Services/ProductStockService.cs†L9-L56】
| [`Repositories.IProductReadRepository`](Backend/ProyectoBase.Domain/Repositories/IProductReadRepository.cs) | Contrato para consultas de solo lectura sobre productos. | `GetByIdAsync`. | Implementado indirectamente por la infraestructura al compartir persistencia con `IProductRepository` de la capa de aplicación. |【F:Backend/ProyectoBase.Domain/Repositories/IProductReadRepository.cs†L8-L20】
| [`Exceptions.DomainException`](Backend/ProyectoBase.Domain/Exceptions/DomainException.cs) y derivados | Jerarquía base para errores de dominio (`NotFoundException`, `ValidationException`). | Constructores específicos. | Consumidos por servicios de aplicación y middleware de la API para traducir errores a respuestas HTTP. |【F:Backend/ProyectoBase.Domain/Exceptions/DomainException.cs†L6-L26】【F:Backend/ProyectoBase.Domain/Exceptions/NotFoundException.cs†L3-L23】【F:Backend/ProyectoBase.Domain/Exceptions/ValidationException.cs†L3-L23】

## Backend/ProyectoBase.Application

| Clase/Archivo | Responsabilidad | Métodos públicos | Dependencias y flujo |
| --- | --- | --- | --- |
| [`Abstractions.IProductRepository`](Backend/ProyectoBase.Application/Abstractions/IProductRepository.cs) | Contrato de persistencia usado por la capa de aplicación. | `GetByIdAsync`, `GetAllAsync`, `AddAsync`, `UpdateAsync`, `DeleteAsync`. | Implementado en `Backend/ProyectoBase.Infrastructure` y decorado con políticas de resiliencia. |【F:Backend/ProyectoBase.Application/Abstractions/IProductRepository.cs†L9-L43】
| [`Abstractions.ITokenService`](Backend/ProyectoBase.Application/Abstractions/ITokenService.cs) | Define la generación de JWT para autenticación. | `GenerateAccessToken`. | Implementado en infraestructura (`Authentication.TokenService`) y usado desde la API durante el inicio de sesión. |【F:Backend/ProyectoBase.Application/Abstractions/ITokenService.cs†L6-L15】
| [`DTOs.ProductCreateDto`](Backend/ProyectoBase.Application/DTOs/ProductCreateDto.cs) / [`ProductUpdateDto`](Backend/ProyectoBase.Application/DTOs/ProductUpdateDto.cs) / [`ProductResponseDto`](Backend/ProyectoBase.Application/DTOs/ProductResponseDto.cs) | Contratos de datos que la API intercambia con la capa de aplicación. | Propiedades con anotaciones de datos. | Mapas definidos en `Mappings.ProductProfile` convierten entre DTO y entidad de dominio. |【F:Backend/ProyectoBase.Application/DTOs/ProductCreateDto.cs†L7-L31】【F:Backend/ProyectoBase.Application/DTOs/ProductUpdateDto.cs†L7-L19】【F:Backend/ProyectoBase.Application/DTOs/ProductResponseDto.cs†L7-L31】
| [`Products.Commands.CreateProduct`](Backend/ProyectoBase.Application/Products/Commands/CreateProduct/CreateProductCommand.cs) & Handler | Atienden la creación de productos a través de MediatR. | Record `CreateProductCommand`; método `Handle` en `CreateProductCommandHandler`. | El handler mapea el DTO a entidad, persiste vía `IProductRepository` y limpia la caché distribuida. |【F:Backend/ProyectoBase.Application/Products/Commands/CreateProduct/CreateProductCommand.cs†L1-L9】【F:Backend/ProyectoBase.Application/Products/Commands/CreateProduct/CreateProductCommandHandler.cs†L1-L63】
| [`Products.Commands.UpdateProduct`](Backend/ProyectoBase.Application/Products/Commands/UpdateProduct/UpdateProductCommand.cs) & Handler | Gestionan actualizaciones de productos existentes. | Record `UpdateProductCommand`; método `Handle` en `UpdateProductCommandHandler`. | El handler obtiene el producto, aplica mapeo y actualiza repositorio y caché; lanza `NotFoundException` cuando corresponde. |【F:Backend/ProyectoBase.Application/Products/Commands/UpdateProduct/UpdateProductCommand.cs†L1-L9】【F:Backend/ProyectoBase.Application/Products/Commands/UpdateProduct/UpdateProductCommandHandler.cs†L1-L69】
| [`Products.Commands.DeleteProduct`](Backend/ProyectoBase.Application/Products/Commands/DeleteProduct/DeleteProductCommand.cs) & Handler | Encargados de eliminar productos. | Record `DeleteProductCommand`; método `Handle` en `DeleteProductCommandHandler`. | El handler delega en el repositorio y expurga la caché tras la eliminación. |【F:Backend/ProyectoBase.Application/Products/Commands/DeleteProduct/DeleteProductCommand.cs†L1-L7】【F:Backend/ProyectoBase.Application/Products/Commands/DeleteProduct/DeleteProductCommandHandler.cs†L1-L55】
| [`Products.Queries.GetProductById`](Backend/ProyectoBase.Application/Products/Queries/GetProductById/GetProductByIdQuery.cs) & Handler | Consultan un producto específico. | Record `GetProductByIdQuery`; método `Handle` en `GetProductByIdQueryHandler`. | El handler transforma la entidad recuperada en DTO y centraliza el manejo de excepciones. |【F:Backend/ProyectoBase.Application/Products/Queries/GetProductById/GetProductByIdQuery.cs†L1-L9】【F:Backend/ProyectoBase.Application/Products/Queries/GetProductById/GetProductByIdQueryHandler.cs†L1-L57】
| [`Products.Queries.GetAllProducts`](Backend/ProyectoBase.Application/Products/Queries/GetAllProducts/GetAllProductsQuery.cs) & Handler | Obtienen el listado de productos con soporte de caché. | Record `GetAllProductsQuery`; método `Handle` en `GetAllProductsQueryHandler`. | El handler lee la caché distribuida, la actualiza al consultar el repositorio y devuelve colecciones inmutables. |【F:Backend/ProyectoBase.Application/Products/Queries/GetAllProducts/GetAllProductsQuery.cs†L1-L9】【F:Backend/ProyectoBase.Application/Products/Queries/GetAllProducts/GetAllProductsQueryHandler.cs†L1-L69】
| [`Products.Common.ProductCacheSettings`](Backend/ProyectoBase.Application/Products/Common/ProductCacheSettings.cs) | Centraliza constantes de caché compartidas por los handlers. | Constantes y opciones de serialización. | Evita duplicación de claves/opciones en los manejadores de productos. |【F:Backend/ProyectoBase.Application/Products/Common/ProductCacheSettings.cs†L1-L15】
| [`Mappings.ProductProfile`](Backend/ProyectoBase.Application/Mappings/ProductProfile.cs) | Configura AutoMapper entre DTO y entidad. | Constructor con reglas `CreateMap`. | Utilizado por los handlers de productos para convertir DTO ↔ entidad. |【F:Backend/ProyectoBase.Application/Mappings/ProductProfile.cs†L8-L37】
| [`Validators.CreateProductDtoValidator`](Backend/ProyectoBase.Application/Validators/CreateProductDtoValidator.cs) y [`UpdateProductDtoValidator`](Backend/ProyectoBase.Application/Validators/UpdateProductDtoValidator.cs) | Validan DTO antes de enviarlos a la lógica de dominio. | Reglas `RuleFor` y `Include`. | Registrados automáticamente mediante `AddApplication` y aplicables dentro de tuberías MediatR o validaciones manuales. |【F:Backend/ProyectoBase.Application/Validators/CreateProductDtoValidator.cs†L7-L29】【F:Backend/ProyectoBase.Application/Validators/UpdateProductDtoValidator.cs†L7-L24】
| [`Exceptions.ApplicationLayerException`](Backend/ProyectoBase.Application/Exceptions/ApplicationLayerException.cs) y [`ProductServiceException`](Backend/ProyectoBase.Application/Exceptions/ProductServiceException.cs) | Encapsulan errores inesperados dentro de la capa de aplicación. | Constructores con mensaje y excepción interna. | Propagados hacia la API para generar respuestas 500 desde el middleware de excepciones. |【F:Backend/ProyectoBase.Application/Exceptions/ApplicationLayerException.cs†L6-L27】【F:Backend/ProyectoBase.Application/Exceptions/ProductServiceException.cs†L6-L19】
| [`Options.JwtOptions`](Backend/ProyectoBase.Application/Options/JwtOptions.cs) | Objeto de configuración para JWT. | Propiedades `Issuer`, `Audience`, `Key`, etc. | Configurado desde `Program.cs` y consumido por `TokenService`. |【F:Backend/ProyectoBase.Application/Options/JwtOptions.cs†L3-L31】
| [`DependencyInjection`](Backend/ProyectoBase.Application/DependencyInjection.cs) | Método de extensión para registrar servicios de aplicación. | `AddApplication`. | Invocado por `Backend/ProyectoBase.Api/Program.cs` para integrar MediatR, AutoMapper y validadores. |【F:Backend/ProyectoBase.Application/DependencyInjection.cs†L11-L33】

## Backend/ProyectoBase.Infrastructure

| Clase/Archivo | Responsabilidad | Métodos públicos | Dependencias y flujo |
| --- | --- | --- | --- |
| [`DependencyInjection`](Backend/ProyectoBase.Infrastructure/DependencyInjection.cs) | Registra infraestructura: EF Core, caché, Polly y repositorios. | `AddInfrastructure`. | Consumido por `Program.cs`; envuelve `ProductRepository` con `ResilientProductRepository` y expone `ITokenService`. |【F:Backend/ProyectoBase.Infrastructure/DependencyInjection.cs†L14-L90】
| [`Persistence.ApplicationDbContext`](Backend/ProyectoBase.Infrastructure/Persistence/ApplicationDbContext.cs) | `DbContext` principal de EF Core. | Propiedad `Products`; `OnModelCreating`. | Usado por repositorios de productos; configurado con `ProductConfiguration`. |【F:Backend/ProyectoBase.Infrastructure/Persistence/ApplicationDbContext.cs†L7-L32】
| [`Persistence.Configurations.ProductConfiguration`](Backend/ProyectoBase.Infrastructure/Persistence/Configurations/ProductConfiguration.cs) | Configuración de mapeo EF para `Product`. | `Configure`. | Aplicado automáticamente en `ApplicationDbContext` al crear el modelo. |【F:Backend/ProyectoBase.Infrastructure/Persistence/Configurations/ProductConfiguration.cs†L7-L31】
| [`Persistence.Repositories.ProductRepository`](Backend/ProyectoBase.Infrastructure/Persistence/Repositories/ProductRepository.cs) | Implementación EF Core de `IProductRepository`. | Métodos CRUD async (`GetByIdAsync`, `GetAllAsync`, `AddAsync`, `UpdateAsync`, `DeleteAsync`). | Invocado por los handlers de productos y decorado por `ResilientProductRepository` para políticas Polly. |【F:Backend/ProyectoBase.Infrastructure/Persistence/Repositories/ProductRepository.cs†L7-L64】
| [`Persistence.Repositories.ResilientProductRepository`](Backend/ProyectoBase.Infrastructure/Persistence/Repositories/ResilientProductRepository.cs) | Decorador que aplica políticas de resiliencia a operaciones de repositorio. | Métodos CRUD delegados envueltos en `IAsyncPolicy`. | Se registra como `IProductRepository` en `AddInfrastructure` y combina políticas de reintento y circuit breaker. |【F:Backend/ProyectoBase.Infrastructure/Persistence/Repositories/ResilientProductRepository.cs†L9-L74】
| [`Authentication.TokenService`](Backend/ProyectoBase.Infrastructure/Authentication/TokenService.cs) | Genera JWT firmados para autenticación. | `GenerateAccessToken`. | Implementa `ITokenService`; usa `JwtOptions` configurados en la API. |【F:Backend/ProyectoBase.Infrastructure/Authentication/TokenService.cs†L15-L55】
| Migraciones EF Core (`Persistence/Migrations/*.cs`) | Definen el esquema inicial y snapshot de la base de datos. | Métodos `Up`/`Down`. | Ejecutadas por herramientas de migración al aprovisionar la base. |

## Backend/ProyectoBase.Api

| Clase/Archivo | Responsabilidad | Métodos públicos | Dependencias y flujo |
| --- | --- | --- | --- |
| [`Program`](Backend/ProyectoBase.Api/Program.cs) | Punto de entrada de la API: configura CORS, autenticación JWT, versionado, Swagger y registra `AddApplication` + `AddInfrastructure`. | Configuración en bloque principal y pipeline `app`. | Conecta la UI HTTP con la capa de aplicación, habilitando flujos JWT y documentación. |【F:Backend/ProyectoBase.Api/Program.cs†L1-L160】【F:Backend/ProyectoBase.Api/Program.cs†L200-L215】
| [`Controllers.V1.ProductsController`](Backend/ProyectoBase.Api/Controllers/V1/ProductsController.cs) | Endpoints CRUD para productos (v1). | `GetProductsAsync`, `GetProductByIdAsync`, `CreateProductAsync`, `UpdateProductAsync`, `DeleteProductAsync`. | Coordina las operaciones mediante `IMediator`, traduce excepciones en respuestas HTTP y aplica autorización. |【F:Backend/ProyectoBase.Api/Controllers/V1/ProductsController.cs†L18-L212】
| [`Middlewares.ExceptionHandlingMiddleware`](Backend/ProyectoBase.Api/Middlewares/ExceptionHandlingMiddleware.cs) | Middleware global para transformar excepciones en respuestas JSON estándar. | `InvokeAsync`. | Analiza `DomainException`, `ValidationException` y otros errores antes de que lleguen al cliente. |【F:Backend/ProyectoBase.Api/Middlewares/ExceptionHandlingMiddleware.cs†L9-L118】
| [`Logging.SafeRequestHeadersLayoutRenderer`](Backend/ProyectoBase.Api/Logging/SafeRequestHeadersLayoutRenderer.cs) | Renderiza encabezados HTTP anonimizados en logs. | `DoAppend` (override), `SanitizeHeaders`. | Utilizado por NLog al configurarse en `Program.cs` o archivos de configuración. |【F:Backend/ProyectoBase.Api/Logging/SafeRequestHeadersLayoutRenderer.cs†L14-L83】
| [`Logging.SafeUserClaimsLayoutRenderer`](Backend/ProyectoBase.Api/Logging/SafeUserClaimsLayoutRenderer.cs) | Renderiza claims del usuario sin datos sensibles. | `DoAppend`, `GetClaimTypeCounts`. | Complementa la observabilidad cuando la API se ejecuta bajo autenticación. |【F:Backend/ProyectoBase.Api/Logging/SafeUserClaimsLayoutRenderer.cs†L14-L61】
| [`Options.ConnectionStringsOptions`](Backend/ProyectoBase.Api/Options/ConnectionStringsOptions.cs) & [`RedisOptions`](Backend/ProyectoBase.Api/Options/RedisOptions.cs) | Representan secciones de configuración específicas de la API. | Propiedades para cadenas de conexión y Redis. | Inyectadas en `Program.cs` y compartidas con la infraestructura. |【F:Backend/ProyectoBase.Api/Options/ConnectionStringsOptions.cs†L1-L8】【F:Backend/ProyectoBase.Api/Options/RedisOptions.cs†L1-L8】
| [`Swagger.ConfigureSwaggerOptions`](Backend/ProyectoBase.Api/Swagger/ConfigureSwaggerOptions.cs) y [`SwaggerGenOptionsExtensions`](Backend/ProyectoBase.Api/Swagger/SwaggerGenOptionsExtensions.cs) | Ajustan la documentación OpenAPI para todas las versiones y enumeraciones. | `Configure`, `MapCodeEnumsFromAssemblies`. | Registrados en `Program.cs` y aplican contratos compartidos con `ProyectoBase.Application` y `ProyectoBase.Domain`. |【F:Backend/ProyectoBase.Api/Swagger/ConfigureSwaggerOptions.cs†L8-L47】【F:Backend/ProyectoBase.Api/Swagger/SwaggerGenOptionsExtensions.cs†L8-L69】
| [`Swagger.Filters.DefaultResponsesOperationFilter`](Backend/ProyectoBase.Api/Swagger/Filters/DefaultResponsesOperationFilter.cs) | Agrega respuestas de error comunes a cada operación documentada. | `Apply`. | Reutiliza `Swagger.ErrorResponse` como esquema compartido entre capas. |【F:Backend/ProyectoBase.Api/Swagger/Filters/DefaultResponsesOperationFilter.cs†L8-L48】

## Flujo de comunicación principal

1. **Solicitud HTTP** llega a `ProyectoBase.Api`, donde `ExceptionHandlingMiddleware` y la canalización configurada en `Program` gestionan autenticación JWT (`ITokenService`) y CORS.
2. `ProductsController` envía comandos y consultas mediante `IMediator`, activando los handlers de la capa de aplicación que orquestan validaciones (`FluentValidation`), servicios de dominio y caché distribuida.
3. Los handlers de productos usan AutoMapper (`ProductProfile`) y validan reglas de dominio en `Product`. Para persistencia, interactúan con `IProductRepository`, cuya implementación (`ResilientProductRepository` → `ProductRepository`) reside en `ProyectoBase.Infrastructure` y usa `ApplicationDbContext`.
4. Las excepciones de dominio (`NotFoundException`, `ValidationException`) y de aplicación (`ProductServiceException`) suben a la API, donde se registran y se transforman en respuestas estándar.
5. Tokens y configuraciones (`JwtOptions`, `RedisOptions`, `ConnectionStringsOptions`) se configuran en `Program` y se comparten con infraestructura y servicios de aplicación para mantener coherencia transversal.

Este contexto facilita a nuevos desarrolladores ubicar rápidamente dónde extender funcionalidades (por ejemplo, creando nuevos comandos/consultas de MediatR y sus handlers) y cómo cada capa coopera dentro del ecosistema `ProyectoBase`.
